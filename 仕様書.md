# 不動産診断システム 計算ロジック仕様書

本ドキュメントは、マイホーム適正予算診断機能における計算ロジックおよび判定基準を定義します。
**コードを修正した場合は、必ず本ドキュメントも更新してください。**

## 1. 入力項目
ユーザーからの回答など、計算に使用する入力値です。

| 項目名 | 変数名 | 定義・備考 |
| :--- | :--- | :--- |
| 世帯年収 | `annualIncome` | 万円単位。範囲選択の場合は中央値を使用（例: 400~600万 -> 500万）。 |
| 自己資金 | `ownCapital` | 万円単位。現在フォームには入力欄がないため `0` 固定。 |
| 既存借入 | `monthlyDebt` | 円単位。月々の返済額。 |
| 現在家賃 | `currentRent` | 円単位。 |
| 希望借入額 | `desiredBudget` | 万円単位。Q13の回答値（範囲の場合は中央値、上限なしの場合は適宜設定）。 |

## 2. 定数（Config）
Script Properties で設定可能です。未設定時は以下のデフォルト値が適用されます。

| 定数名 | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `RATE_FLOATING` | 0.5% | 変動金利（審査金利として使用）。 |
| `RATE_FIXED` | 1.8% | 固定金利（参考用、現在は主要計算には変動を使用）。 |
| `TERM_YEARS` | 35年 | 返済期間。 |
| `RATIO_SAFE` | 20% (0.20) | 安全圏とされる返済負担率。 |
| `RATIO_MAX` | 35% (0.35) | 借入上限の返済負担率。 |

## 3. 計算式

### 3.1. 月々返済可能額
年収に対し、設定された返済負担率を乗じて算出します。
※ 本来は「既存借入」を差し引くべきですが、簡易診断では総借入枠の目安を示すため、ここでは差し引かずに全体枠を計算し、アドバイス等で考慮します。（※将来的に既存借入を差し引くロジックへ変更する可能性あり）

*   **最大月々返済額** (`maxMonthlyPayment`)
    $$ \text{maxMonthlyPayment} = (\text{annualIncome} \times 10000 \times \text{RATIO\_MAX}) / 12 $$

*   **安全月々返済額** (`safeMonthlyPayment`)
    $$ \text{safeMonthlyPayment} = (\text{annualIncome} \times 10000 \times \text{RATIO\_SAFE}) / 12 $$

### 3.2. 借入可能額（ローン元本）
元利均等返済方式で、利率・期間・月々返済額から現在価値（PV）を算出します。

*   **最大借入可能額** (`maxLoan`)
    $$ \text{maxLoan} = PV(\text{RATE\_FLOATING}, \text{TERM\_YEARS}, \text{maxMonthlyPayment}) $$

*   **安全借入可能額** (`safeLoan`)
    $$ \text{safeLoan} = PV(\text{RATE\_FLOATING}, \text{TERM\_YEARS}, \text{safeMonthlyPayment}) $$

### 3.3. 予算総額（物件価格目安）
借入可能額に自己資金を加えたものです。万円単位で切り捨てます。

*   **最大予算** (`maxBudget`)
    $$ \text{maxBudget} = \lfloor (\text{maxLoan} + \text{ownCapital} \times 10000) / 10000 \rfloor $$

*   **推奨予算（安全圏）** (`safeBudget`)
    $$ \text{safeBudget} = \lfloor (\text{safeLoan} + \text{ownCapital} \times 10000) / 10000 \rfloor $$

## 4. 判定ロジック（ゾーン判定）

ユーザーの「希望購入価格帯 (`desiredBudget`)」と、計算された「推奨予算 (`safeBudget`)」「最大予算 (`maxBudget`)」を比較し、判定を行います。

| ランク | 判定名 | 条件 | アドバイス方針 |
| :--- | :--- | :--- | :--- |
| **A** | **安全圏 (Safe)** | `desiredBudget` <= `safeBudget` | 余裕あり。グレードアップなども検討可能。 |
| **B** | **検討圏 (Caution)** | `safeBudget` < `desiredBudget` <= `maxBudget` | 平均的。金利上昇リスクや諸費用を考慮すべき。 |
| **C** | **警戒圏 (Danger)** | `desiredBudget` > `maxBudget` | 予算オーバーの懸念。エリア見直しや頭金の準備を推奨。 |

※ `desiredBudget` が不明（「わからない」等）の場合は、標準的な **ランクB (検討圏)** として扱います。

## 5. 出力
*   **LINE Flex Message:** ゾーン名（Safe/Caution/Danger）と、推奨予算範囲（`safeBudget` ±5%程度）を表示します。
*   **スプレッドシート:** 計算結果およびランクを記録します。
