# 不動産診断システム 計算ロジック仕様書

本ドキュメントは、マイホーム適正予算診断機能における計算ロジックおよび判定基準を定義します。
**コードを修正した場合は、必ず本ドキュメントも更新してください。**

## 1. 入力項目
ユーザーからの回答など、計算に使用する入力値です。

| 項目名 | 変数名 | 定義・備考 |
| :--- | :--- | :--- |
| 世帯年収 | `annualIncome` | 万円単位。範囲選択の場合は中央値を使用（例: 400~600万 -> 500万）。 |
| 自己資金 | `ownCapital` | 万円単位。現在フォームには入力欄がないため `0` 固定。 |
| 既存借入 | `monthlyDebt` | 円単位。月々の返済額。 |
| 現在家賃 | `currentRent` | 円単位。 |
| 希望借入額 | `desiredBudget` | 万円単位。Q13の回答値（範囲の場合は中央値、上限なしの場合は適宜設定）。 |

## 2. 定数（Config）
Script Properties で設定可能です。未設定時は以下のデフォルト値が適用されます。

| 定数名 | デフォルト値 | 説明 |
| :--- | :--- | :--- |
| `RATE_FLOATING` | 0.5% | 変動金利（審査金利として使用）。 |
| `RATE_FIXED` | 1.8% | 固定金利（参考用）。 |
| `TERM_YEARS` | 35年 | 返済期間。 |

## 3. 返済比率（ハードコード）

### 3.1. 借入可能額（銀行融資目線）＝上限予算
雇用形態・年収に応じた返済比率を適用します。

| 条件 | 返済比率 |
| :--- | :--- |
| **公務員** | 40% |
| 年収 400万円以上（公務員以外） | 35% |
| 年収 400万円未満（公務員以外） | 30% |

※ 雇用形態は Q3 の回答値（`PUBLIC`）で判定。

### 3.2. 借入おすすめ額（安全ゾーン）＝安全予算
生活を崩さない安全圏として、一律 **20%** を適用します。

## 4. 計算式

### 4.1. 月々返済可能額
*   **上限** = `annualIncome × 10000 × ratioMax / 12`
*   **安全** = `annualIncome × 10000 × 0.20 / 12`

### 4.2. 借入可能額（PV関数）
元利均等返済方式で算出。
*   `maxLoan = PV(RATE_FLOATING, TERM_YEARS×12, maxMonthlyPayment)`
*   `safeLoan = PV(RATE_FLOATING, TERM_YEARS×12, safeMonthlyPayment)`

### 4.3. 予算総額
*   `maxBudget = floor((maxLoan + ownCapital × 10000) / 10000)` 万円
*   `safeBudget = floor((safeLoan + ownCapital × 10000) / 10000)` 万円

## 5. 判定ロジック（ゾーン判定）

ユーザーの「希望購入価格帯 (`desiredBudget`)」と計算結果を比較します。

| ランク | 判定名 | 条件 |
| :--- | :--- | :--- |
| **A** | 安全圏 (Safe) | `desiredBudget` ≤ `safeBudget` |
| **B** | 検討圏 (Caution) | `safeBudget` < `desiredBudget` ≤ `maxBudget` |
| **C** | 警戒圏 (Danger) | `desiredBudget` > `maxBudget` |

※ `desiredBudget` 不明 → ランクB。

## 6. 出力
*   **LINE Flex Message:** 希望整理シート（条件一覧）とアドバイスのみ表示。予算金額は非表示。
*   **スプレッドシート:** 安全予算・上限予算を含む全データを記録。

