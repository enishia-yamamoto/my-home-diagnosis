# 要件定義書：LINEマイホーム診断ボット（本番実装版）

## 1. プロジェクト概要
LINE公式アカウント上で動作する「マイホーム適正予算診断」アプリ。
LIFF（LINE Front-end Framework）を用いたオリジナルフォームで入力を受け付け、GASで計算し、LINE Flex Messageでリッチな診断結果を返し、Dify（AI）で相談を受け付ける。

## 2. システムアーキテクチャ
* **Frontend:** GitHub Pages (Custom LIFF App)
    * HTML/CSS/JSによるレスポンシブデザイン
* **Backend:** Google Apps Script (GAS)
    * API Endpoint (`doPost`)
* **Database:** Google Spreadsheet
    * `Config`: 設定マスタ
    * `Users`: ユーザーデータ＆診断履歴
    * `Debug`: デバッグログ
* **AI Engine:** Dify (LLM)
* **Messaging:** LINE Messaging API (Push/Reply/Flex Message)

---

## 3. データモデル定義 (Google Spreadsheet)

### 3.1. `Config` シート（マスタ管理）
管理者（クライアント）が変更するパラメータ。

| Key (A列) | Value (B列) | Description (C列) | 変数名(GAS用) |
| :--- | :--- | :--- | :--- |
| RATE_FLOATING | 0.475 | 変動金利(%) | `rateFloating` |
| RATE_FIXED | 1.8 | 固定金利(%) | `rateFixed` |
| TERM_YEARS | 35 | 返済期間(年) | `termYears` |
| RATIO_SAFE | 0.20 | 安全返済比率(20%) | `ratioSafe` |
| RATIO_MAX | 0.35 | 限界返済比率(35%) | `ratioMax` |
| LINE_CHANNEL_ACCESS_TOKEN | (token) | LINEアクセストークン | `lineChannelAccessToken` |
| DIFY_API_KEY | (key) | Dify APIキー | `difyApiKey` |

### 3.2. `Users` シート（ユーザーデータ）
GASにより自動更新・蓄積される。**最新情報のみ保持（上書き）。**

| 列順 | 項目名 | データ型 | 備考 |
| :--- | :--- | :--- | :--- |
| 1 | UserId | String | LINEユーザーID (Key) |
| 2 | **DisplayName** | String | **LINE表示名 (New)** |
| 3 | AnnualIncome | Number | 年収 (万円) |
| 4 | OwnCapital | Number | 自己資金 (万円) |
| 5 | CurrentRent | Number | 現在の家賃 (円) |
| 6 | FamilyStructure | String | 家族構成 |
| 7 | TargetArea | String | 希望エリア |
| 8 | MustConditions | String | 譲れない条件 |
| 9 | **IntentLevel** | String | **検討熱量 (New)** |
| 10 | SafeBudget | Number | 適正予算 (万円) |
| 11 | MaxBudget | Number | 借入上限 (万円) |
| 12 | Rank | String | 判定ランク (A/B/C) |
| 13 | ConversationId | String | Dify会話ID |
| 14 | Updated | Date | 最終更新日時 |

### 3.3. `Logs` シート（診断履歴ログ）
**診断が行われるたびに追記される（全履歴保存）。**

*   **Timestamp**: 実行日時
*   **UserId**: LINEユーザーID
*   **DisplayName**: LINE表示名
*   **InputData**: 入力内容（JSON等で保存、または各カラム展開）
*   **ResultData**: 診断結果（予算、ランク等）

---

## 4. 機能要件詳細

### 4.1. LIFFフロントエンド (GitHub Pages)
* **URL:** `https://enishia-yamamoto.github.io/my-home-diagnosis/`
* **LIFF Size:** `Tall`
* **機能:**
    1. LIFF初期化 (`liff.init`) し、LINEユーザーIDを取得。
    2. **検討熱量（IntentLevel）の確認:**
        *   すぐに購入 / 1-2年以内 / 情報収集中 などの選択肢を表示。
    3. **選択式入力フォーム:**
        *   ユーザーの熱量に応じて設問数や深度を動的に変更（例：ライト層は概算回答、本気層は詳細数値入力）。
    4. 「診断する」ボタン押下で、入力データをGASのWebアプリURL (`exec`) へPOST送信。

### 4.2. 診断ロジック (GAS Backend)
1.  **データ保存処理:**
    *   **Usersシート:** `UserId`をキーに行を検索し、存在すれば**上書き更新**、なければ新規作成。
    *   **Logsシート:** 常に最下行へ**新規追加（Append）**。
    *   **プロフィール取得:** LINE Messaging API (`getProfile`) を使用して、`UserId`から現在の`DisplayName`を取得・保存する。

2.  **月々返済額 (PMT) 計算**
    *   計算式: 元利均等返済方式
3.  **借入上限 (MaxBudget) 算出**
    *   年収 × 限界返済比率(`RATIO_MAX`) ÷ 12 ＝ 月々上限返済額
    *   審査金利（Configの`RATE_FLOATING`を使用）で逆算した借入可能額 ＋ 自己資金
4.  **適正予算 (SafeBudget) 算出**
    *   年収 × 安全返済比率(`RATIO_SAFE`) ÷ 12 ＝ 安全月々返済額
    *   変動金利で逆算した借入適正額 ＋ 自己資金
5.  **ランク判定**
    *   **Aランク**: 適正予算 ÷ 借入上限 ≧ 0.8 (余裕あり)
    *   **Bランク**: 0.6 ≦ 比率 ＜ 0.8 (適正)
    *   **Cランク**: 比率 ＜ 0.6 (予算オーバー気味)

### 4.3. 結果出力 (Flex Message)
`MessageBuilder` クラスにて生成。

*   **デザイン**:
    *   **ヘッダー**: ランク判定（A/B/C）を表示。ランクに応じて背景色を変更（A=緑, B=橙, C=赤）。
    *   **適正予算**: 特大フォントで強調表示。
    *   **プログレスバー**: 「借入可能額」に対する「安全圏」の割合を視覚化。
    *   **アドバイス**: ランクに応じた個別メッセージを表示。
    *   **アクション**:
        *   「この条件でプロに相談」: 診断結果をテキストとして送信し、有人対応またはAI相談へ誘導。
        *   「条件を変更して再診断」: 再度LIFFを開く。

### 4.4. Dify連携 (AIチャット)
`Dify` クラスにて連携。

*   **トリガー**: ユーザーからのテキストメッセージ受信時。
*   **コンテキスト**: スプレッドシート(`Users`)から最新の診断結果を取得し、AIへの入力(`inputs`)として渡す。
*   **挙動**: ユーザーが「この予算でつくば市に買える？」と聞くと、AIは「年収xxx万円、予算xxx万円ですね。つくば市の相場は...」と、個別の事情を踏まえた回答を行う。

---

## 5. API・環境変数

*   **LINE_CHANNEL_ACCESS_TOKEN**: Messaging API用トークン
*   **DIFY_API_KEY**: AIチャットボット用キー
*   **GAS_API_URL**: フロントエンド(`app.js`)から叩くエンドポイント
