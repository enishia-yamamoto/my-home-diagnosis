# 要件定義書：LINEマイホーム診断ボット（PoC版）

## 1. プロジェクト概要
LINE公式アカウント上で動作する「マイホーム適正予算診断」アプリ。
Googleフォームで入力を受け付け、GASで計算し、LINE Flex Messageで結果を返し、Dify（AI）で相談を受け付ける。

## 2. システムアーキテクチャ
* **Frontend:** LINE Official Account (LIFF / Flex Message)
* **Input:** Google Forms (Pre-filled URL via LIFF)
* **Backend:** Google Apps Script (GAS)
* **Database:** Google Spreadsheet
* **AI Engine:** Dify (LLM)

---

## 3. データモデル定義 (Google Spreadsheet)

シートを2つ作成する前提で実装する。

### 3.1. `Config` シート（マスタ管理）
管理者（クライアント）が変更するパラメータ。

| Key (A列) | Value (B列) | Description (C列) | 変数名(GAS用) |
| :--- | :--- | :--- | :--- |
| RATE_FLOATING | 0.475 | 変動金利(%) | `rateFloating` |
| RATE_FIXED | 1.8 | 固定金利(%) | `rateFixed` |
| TERM_YEARS | 35 | 返済期間(年) | `termYears` |
| RATIO_SAFE | 0.20 | 安全返済比率(20%) | `ratioSafe` |
| RATIO_MAX | 0.35 | 限界返済比率(35%) | `ratioMax` |
| DIFY_API_KEY | (key) | Dify APIキー | `difyApiKey` |

### 3.2. `Log` シート（回答データ）
Googleフォームからの回答格納先（フォーム作成時に自動生成されるが、列順序をGASで特定する）。

| 列名(ヘッダー) | データ型 | 変数名 | 備考 |
| :--- | :--- | :--- | :--- |
| タイムスタンプ | Date | `timestamp` | 自動生成 |
| 年収（額面） | Number | `annualIncome` | 単位：万円 |
| 自己資金 | Number | `ownCapital` | 単位：万円 |
| 現在の家賃 | Number | `currentRent` | 単位：円 |
| 家族構成 | String | `familyStructure` | 選択肢 |
| 希望エリア | String | `targetArea` | 選択肢/記述 |
| 譲れない条件 | String | `mustConditions` | 複数選択 |
| LINE UserID | String | `userId` | **※自動入力・バリデーション必須** |

---

## 4. 機能要件詳細

### 4.1. LIFF & フォーム連携機能
* **LIFF Size:** `Tall`
* **挙動:**
    1. LIFF起動時に `liff.getProfile()` で `userId` を取得。
    2. Googleフォームの事前入力URL (`viewform?entry.XXXXX=userId`) を生成。
    3. `window.location.replace()` でフォームへリダイレクト。
* **フォームバリデーション (必須):**
    * 項目名: `システム識別ID（変更不可）`
    * 正規表現: `^U[0-9a-f]{32}$`
    * エラー文言: `※システム連携用コードです。変更すると診断結果が届きません。`

### 4.2. 診断ロジック (GASクラス設計)
`Calculator` クラスを作成し、以下のメソッドを実装する。

1. **PMT計算 (月々返済額算出)**
    * 数式: `借入額 * 月利 / (1 - (1 + 月利)^(-返済回数))`
2. **借入可能額 (MaxBudget) 算出**
    * `年収 * RATIO_MAX / 12` = 月々返済上限
    * 上記返済額から逆算した元金（審査金利 3.0% ではなく、簡易的に `RATE_FLOATING` または指定金利で計算するか要調整。一旦、指定金利で計算）
3. **適正予算 (SafeBudget) 算出**
    * `年収 * RATIO_SAFE / 12` = 安全月々返済額
    * 上記から逆算した元金 + `ownCapital`

### 4.3. 結果出力 (Flex Message)
`MessageBuilder` クラスを作成。JSONペイロードを動的に生成する。

* **Header:** 緑色背景 (`#06C755`)。「診断結果：Bランク」などを表示。
* **Hero:** `SafeBudget` (例: 3,200万円) を特大サイズで表示。
* **Body:**
    * Table形式で「借入上限」「月々返済目安」を表示。
    * 「希望条件」を列挙。
* **Footer:**
    * Button A: `action: message` -> Label: 「この条件でプロに相談」, Text: 「【相談希望】予算3200万/エリア...」
    * Button B: `action: uri` -> Label: 「Difyと相談する(まだ未実装なら非表示)」

### 4.4. Dify連携 (AIチャット)
* **Trigger:** ユーザーからのテキストメッセージ受信時 (`Webhook`)
* **Process:**
    1. GASで `Log` シートを検索し、その `userId` の最新診断結果を取得。
    2. Dify API (`/chat-messages`) をコール。
    3. `inputs` パラメータに診断結果を注入。
        * `income`: 500
        * `budget`: 3200
        * `area`: つくば市
* **Response:** Difyからの返答をLINEへ `replyMessage`。

---

## 5. 開発ステップ（バイブコーディング用指示書）

AIエージェントに指示する際は、以下の順序でコードを書かせてください。

### Step 1: フォームとシートの準備
> 「Googleフォームを作成し、スプレッドシートと連携してください。スプレッドシートには別途 `Config` シートを作り、以下のキーバリュー（3.1参照）を入れてください。」

### Step 2: GASプロジェクト構成
> 「GASで以下のファイル構成を作ってください。
> - `main.gs`: トリガー処理 (doPost, onFormSubmit)
> - `config.gs`: Configシート読み込みクラス
> - `calculator.gs`: 予算計算ロジッククラス
> - `line.gs`: Messaging API, Flex Message生成クラス
> - `liff.html`: フォーム転送用HTML」

### Step 3: 計算ロジックの実装
> 「`calculator.gs` に、年収と返済比率、金利（Configから取得）をもとに、PMT関数を用いて借入可能額を逆算するロジックを実装してください。」

### Step 4: Flex Messageの実装
> 「診断結果を表示するFlex MessageのJSONを作ってください。金額部分は変数化し、デザインはシンプルで見やすいカード型にしてください。」

### Step 5: Webhook & トリガー設定
> 「フォーム送信トリガー (`onFormSubmit`) で計算を実行し、LINEにプッシュ通知を送る関数 `handleFormSubmit` を書いてください。」

---

## 6. API・環境変数

* **LINE_CHANNEL_ACCESS_TOKEN:** (LINE Developersより取得)
* **SPREADSHEET_ID:** (作成したシートのID)
* **LIFF_ID:** (LIFF作成後に取得)